{% extends "base.html" %}

{% block title %}Teacher Dashboard - Exam System{% endblock %}

{% block content %}
<h1 data-i18n="teacher_dashboard">Teacher Dashboard</h1>

<!-- Active Exams Section -->
<div class="card" style="margin-bottom: 20px;">
    <div class="card-header" style="background: #28a745; color: white;">
        <h3>üü¢ Active Exams (Running Now)</h3>
    </div>
    <div class="card-body">
        <div id="active-exams-list">
            <p style="text-align: center; color: #999;">Loading active exams...</p>
        </div>
    </div>
</div>

<div class="grid-3">
    <div class="card">
        <div class="card-header">
            <h3 data-i18n="my_exams">My Exams</h3>
        </div>
        <div class="card-body">
            <p data-i18n="view_and_manage">Click to view and manage your uploaded exams</p>
            <a href="{{ url_for('teacher_exams') }}" class="btn btn-primary" style="width: 100%;" data-i18n="view_my_exams">View My Exams</a>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3 data-i18n="results">Results</h3>
        </div>
        <div class="card-body">
            <p data-i18n="no_results">No results available</p>
            <a href="{{ url_for('teacher_results') }}" class="btn btn-primary" style="width: 100%;" data-i18n="view_results">View</a>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3 data-i18n="upload_exam">Upload Exam</h3>
        </div>
        <div class="card-body">
            <form id="uploadForm" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="examFile" data-i18n="select_txt_file"><strong>Select .txt file:</strong></label>
                    <div style="display: flex; align-items: center; gap: 10px; margin: 10px 0;">
                        <input type="file" id="examFile" name="file" accept=".txt" required style="display: none;">
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('examFile').click();" style="flex: 0; padding: 6px 12px; font-size: 13px; white-space: nowrap;" data-i18n="browse">üìÅ Browse</button>
                        <span id="fileName" style="flex: 1; color: #666; font-size: 0.9em;" data-i18n="no_file_chosen">No file chosen</span>
                    </div>
                    <small style="display: block; margin: 5px 0; color: #666;">
                        <span>‚úì </span><span data-i18n="only_txt_files">Only .txt files (text format)</span><br>
                        <span>‚úì </span><span data-i18n="each_exam_one_file">Each exam = one .txt file</span>
                    </small>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 10px;" data-i18n="add_exam">Upload Exam</button>
            </form>
            <div id="uploadMessage" class="mt-2" style="display: none; padding: 10px; border-radius: 4px; margin-top: 10px;"></div>
        </div>
    </div>
</div>

<div class="card" style="margin-top: 20px;">
    <div class="card-header">
        <h3 data-i18n="where_stored">üìÅ Where are my exams stored?</h3>
    </div>
    <div class="card-body" style="font-family: monospace; background: #f5f5f5; padding: 15px; border-radius: 4px;">
        <p><strong data-i18n="files_saved_in">Files are saved in:</strong></p>
        <code style="display: block; margin: 10px 0; word-break: break-all;">
            Ex/data/teachers/teacher_{{ user_id }}/exams/
        </code>
        <p style="margin-top: 10px; color: #666;">
            <span>‚úì </span><span data-i18n="after_upload_go_to_my_exams">After uploading, go to "My Exams" to see them</span><br>
            <span>‚úì </span><span data-i18n="click_start_to_begin">Click "Start" to begin an exam</span><br>
            <span>‚úì </span><span data-i18n="click_delete_to_remove">Click "Delete" to remove an exam</span>
        </p>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Update file name display when file is selected
document.getElementById('examFile').addEventListener('change', function() {
    const fileNameSpan = document.getElementById('fileName');
    if (this.files && this.files[0]) {
        fileNameSpan.textContent = this.files[0].name;
    } else {
        fileNameSpan.textContent = fileNameSpan.getAttribute('data-i18n') ? i18n.t('no_file_chosen') : 'No file chosen';
    }
});

// Function to show confirmation dialog
function showOverwriteDialog(filename) {
    return new Promise((resolve) => {
        const title = typeof i18n !== 'undefined' ? i18n.t('file_already_exists') : 'File already exists';
        const message = typeof i18n !== 'undefined' ? i18n.t('overwrite_question') : 'A file with this name already exists. Do you want to overwrite it?';
        const yesText = typeof i18n !== 'undefined' ? i18n.t('yes_overwrite') : 'Yes, Overwrite';
        const noText = typeof i18n !== 'undefined' ? i18n.t('no_cancel') : 'No, Cancel';
        
        const dialogHtml = `
            <div id="overwriteDialog" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;">
                <div style="background: white; border-radius: 8px; padding: 24px; max-width: 400px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    <h3 style="margin: 0 0 12px 0; color: #333;">${title}</h3>
                    <p style="margin: 0 0 16px 0; color: #666;">${message}</p>
                    <p style="margin: 0 0 20px 0; font-family: monospace; background: #f5f5f5; padding: 8px; border-radius: 4px; color: #333; word-break: break-all;">${filename}</p>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button id="noBtn" style="padding: 8px 16px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer; color: #333;">${noText}</button>
                        <button id="yesBtn" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">${yesText}</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', dialogHtml);
        
        document.getElementById('yesBtn').addEventListener('click', () => {
            document.getElementById('overwriteDialog').remove();
            resolve(true);
        });
        
        document.getElementById('noBtn').addEventListener('click', () => {
            document.getElementById('overwriteDialog').remove();
            resolve(false);
        });
    });
}

// Function to upload file
async function uploadFile(file, overwrite = false) {
    const formData = new FormData();
    formData.append('file', file);
    
    const endpoint = overwrite ? '/api/upload-exam/overwrite' : '/api/upload-exam';
    const response = await fetch(endpoint, {
        method: 'POST',
        body: formData
    });
    
    return {
        status: response.status,
        data: await response.json()
    };
}

document.getElementById('uploadForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const fileInput = document.getElementById('examFile');
    const file = fileInput.files[0];
    const messageDiv = document.getElementById('uploadMessage');
    
    if (!file) {
        messageDiv.textContent = '‚ùå ' + (typeof i18n !== 'undefined' ? i18n.t('please_select_file') : 'Please select a file');
        messageDiv.className = 'alert alert-danger';
        messageDiv.style.display = 'block';
        return;
    }
    
    if (!file.name.endsWith('.txt')) {
        messageDiv.textContent = '‚ùå ' + (typeof i18n !== 'undefined' ? i18n.t('only_txt_accepted') : 'Only .txt files are accepted');
        messageDiv.className = 'alert alert-danger';
        messageDiv.style.display = 'block';
        return;
    }
    
    try {
        const uploadResult = await uploadFile(file, false);
        
        // Check if file exists (409 Conflict)
        if (uploadResult.status === 409 && uploadResult.data.file_exists) {
            const shouldOverwrite = await showOverwriteDialog(file.name);
            
            if (shouldOverwrite) {
                // Upload with overwrite flag
                const overwriteResult = await uploadFile(file, true);
                
                if (overwriteResult.data.success) {
                    const uploadedText = typeof i18n !== 'undefined' ? i18n.t('exam_uploaded') : 'Exam uploaded';
                    const goToExamsText = typeof i18n !== 'undefined' ? i18n.t('go_to_my_exams') : 'Go to "My Exams" to see it';
                    messageDiv.innerHTML = '‚úÖ ' + uploadedText + ': ' + file.name + '<br><small>' + goToExamsText + '</small>';
                    messageDiv.className = 'alert alert-success';
                    messageDiv.style.display = 'block';
                    fileInput.value = '';
                    document.getElementById('fileName').textContent = i18n.t('no_file_chosen');
                } else {
                    messageDiv.textContent = '‚ùå ' + (overwriteResult.data.message || (typeof i18n !== 'undefined' ? i18n.t('error_uploading') : 'Error uploading exam'));
                    messageDiv.className = 'alert alert-danger';
                    messageDiv.style.display = 'block';
                }
            }
            // If user clicked "No, Cancel", just close dialog without doing anything
            return;
        }
        
        // Handle other responses
        if (uploadResult.data.success) {
            const uploadedText = typeof i18n !== 'undefined' ? i18n.t('exam_uploaded') : 'Exam uploaded';
            const goToExamsText = typeof i18n !== 'undefined' ? i18n.t('go_to_my_exams') : 'Go to "My Exams" to see it';
            messageDiv.innerHTML = '‚úÖ ' + uploadedText + ': ' + file.name + '<br><small>' + goToExamsText + '</small>';
            messageDiv.className = 'alert alert-success';
            messageDiv.style.display = 'block';
            fileInput.value = '';
            document.getElementById('fileName').textContent = i18n.t('no_file_chosen');
        } else {
            messageDiv.textContent = '‚ùå ' + (uploadResult.data.message || (typeof i18n !== 'undefined' ? i18n.t('error_uploading') : 'Error uploading exam'));
            messageDiv.className = 'alert alert-danger';
            messageDiv.style.display = 'block';
        }
    } catch (error) {
        console.error('Error:', error);
        messageDiv.textContent = '‚ùå ' + (typeof i18n !== 'undefined' ? i18n.t('error_uploading') : 'Error uploading exam');
        messageDiv.className = 'alert alert-danger';
        messageDiv.style.display = 'block';
    }
});

// Load active exams
async function loadActiveExams() {
    try {
        const response = await fetch('/api/active-exams');
        const data = await response.json();
        
        const container = document.getElementById('active-exams-list');
        
        if (data.success && data.exams && data.exams.length > 0) {
            container.innerHTML = '';
            
            data.exams.forEach(exam => {
                const examCard = document.createElement('div');
                examCard.style.cssText = 'border: 2px solid #28a745; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: #f8fff9;';
                
                const studentsCount = exam.students_count || 0;
                const completedCount = exam.completed_count || 0;
                const activeCount = studentsCount - completedCount;
                
                examCard.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 250px;">
                            <h4 style="margin: 0 0 10px 0; color: #28a745;">
                                üìù ${exam.exam_title}
                            </h4>
                            <div style="color: #666; font-size: 14px;">
                                <div style="margin: 5px 0;">
                                    <strong>Started:</strong> ${new Date(exam.start_time).toLocaleString()}
                                </div>
                                <div style="margin: 5px 0;">
                                    <strong>Students:</strong> 
                                    <span style="color: #28a745;">‚úì ${completedCount} completed</span>
                                    / <span style="color: #007bff;">‚è≥ ${activeCount} active</span>
                                    / <strong>${studentsCount} total</strong>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <a href="/teacher/exam/${exam.exam_id}/monitor" 
                               class="btn btn-primary" 
                               style="text-decoration: none;">
                                üëÅÔ∏è Monitor
                            </a>
                            <button onclick="endExam(${exam.exam_id})" 
                                    class="btn btn-danger"
                                    style="background: #dc3545;">
                                üõë End Exam
                            </button>
                        </div>
                    </div>
                    <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 4px; border: 1px solid #ddd; font-family: monospace; font-size: 13px;">
                        <strong>Student Access URL:</strong><br>
                        <a href="${exam.student_url}" target="_blank" style="color: #007bff; word-break: break-all;">
                            ${exam.student_url}
                        </a>
                        <button onclick="copyToClipboard('${exam.student_url}')" 
                                style="margin-left: 10px; padding: 4px 8px; font-size: 12px; cursor: pointer;">
                            üìã Copy
                        </button>
                    </div>
                `;
                
                container.appendChild(examCard);
            });
        } else {
            container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No active exams. Start an exam from "My Exams".</p>';
        }
    } catch (error) {
        console.error('Error loading active exams:', error);
        document.getElementById('active-exams-list').innerHTML = '<p style="text-align: center; color: #dc3545;">Error loading exams</p>';
    }
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        alert('URL copied to clipboard!');
    });
}

async function endExam(examId) {
    if (!confirm('Are you sure you want to end this exam?\n\nStudents will not be able to access it anymore.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/exam/${examId}/end`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Exam ended successfully');
            loadActiveExams();
        } else {
            alert('Error: ' + data.message);
        }
    } catch (error) {
        console.error('Error ending exam:', error);
        alert('Error ending exam');
    }
}

// Load active exams on page load
document.addEventListener('DOMContentLoaded', () => {
    loadActiveExams();
    // Refresh every 10 seconds
    setInterval(loadActiveExams, 10000);
});
</script>

<style>
.alert {
    padding: 10px;
    border-radius: 4px;
    margin-top: 10px;
}

.alert-success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.alert-danger {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}
</style>
{% endblock %}
