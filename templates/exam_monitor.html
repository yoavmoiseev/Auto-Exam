{% extends "base.html" %}

{% block title %}{{ exam_title }} - Exam Monitor{% endblock %}

{% block content %}
<style>
    .monitor-container {
        max-width: 1400px;
        margin: 0 auto;
    }
    
    .monitor-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .monitor-header h1 {
        margin: 0 0 10px 0;
        font-size: 32px;
    }
    
    .exam-info {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .info-card {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
    }
    
    .info-card-label {
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
        margin-bottom: 5px;
    }
    
    .info-card-value {
        font-size: 18px;
        font-weight: bold;
        color: #333;
    }
    
    .student-link {
        background: #f9f9f9;
        padding: 10px;
        border-radius: 4px;
        font-family: monospace;
        word-break: break-all;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .copy-btn {
        padding: 5px 10px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
    }
    
    .copy-btn:hover {
        background: #0056b3;
    }
    
    .students-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
    }
    
    .students-table thead {
        background: #f9f9f9;
        border-bottom: 2px solid #ddd;
    }
    
    .students-table th {
        padding: 15px;
        text-align: left;
        font-weight: bold;
        color: #333;
    }
    
    .students-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #ddd;
    }
    
    .students-table tbody tr:hover {
        background: #f5f5f5;
    }
    
    .status-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
    }
    
    .status-in-progress {
        background: #d1ecf1;
        color: #0c5460;
    }
    
    .status-completed {
        background: #d4edda;
        color: #155724;
    }
    
    .status-abandoned {
        background: #f8d7da;
        color: #721c24;
    }
    
    .cheating-warning {
        background: #ffe6e6;
        color: #c41e3a;
        font-weight: bold;
    }
    
    .time-display {
        font-family: monospace;
        font-size: 14px;
    }
    
    .score-display {
        font-weight: bold;
        font-size: 16px;
    }
    
    .score-display.high {
        color: #28a745;
    }
    
    .score-display.medium {
        color: #ffc107;
    }
    
    .score-display.low {
        color: #dc3545;
    }
    
    .no-students {
        text-align: center;
        padding: 40px;
        color: #666;
    }
    
    .refresh-info {
        font-size: 12px;
        color: #999;
        margin-top: 10px;
        text-align: center;
    }
    
    .controls {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }
    
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
    }
    
    .btn-primary {
        background: #007bff;
        color: white;
    }
    
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
    
    .btn-danger {
        background: #dc3545;
        color: white;
    }
    
    .btn:hover {
        opacity: 0.8;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .stat-box {
        background: white;
        border-left: 4px solid #007bff;
        padding: 15px;
        border-radius: 4px;
        text-align: center;
    }
    
    .stat-box.active {
        border-left-color: #28a745;
    }
    
    .stat-box.completed {
        border-left-color: #20c997;
    }
    
    .stat-box.suspicious {
        border-left-color: #dc3545;
    }
    
    .stat-number {
        font-size: 28px;
        font-weight: bold;
        color: #333;
    }
    
    .stat-label {
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
    }
</style>

<div class="monitor-container">
    <!-- Header -->
    <div class="monitor-header">
        <h1 data-i18n="exam_monitor">üìä Exam Monitor</h1>
        <p style="margin: 0; font-size: 16px;">{{ exam_title }} - <span data-i18n="live_activity">Live Activity</span></p>
    </div>
    
    <!-- Exam Information -->
    <div class="exam-info">
        <div class="info-card">
            <div class="info-card-label" data-i18n="exam_id">Exam ID</div>
            <div class="info-card-value">{{ exam_id }}</div>
        </div>
        
        <div class="info-card">
            <div class="info-card-label" data-i18n="exam_title">Exam Title</div>
            <div class="info-card-value">{{ exam_title }}</div>
        </div>
        
        <div class="info-card">
            <div class="info-card-label" data-i18n="status">Status</div>
            <div class="info-card-value" style="color: #28a745;" data-i18n="running">üü¢ Running</div>
        </div>
    </div>
    
    <!-- Student Access Link -->
    <div class="card" style="margin-bottom: 20px;">
        <div class="card-header">
            <h3 style="margin: 0;" data-i18n="student_access_link">üìé Student Access Link</h3>
        </div>
        <div class="card-body">
            <div class="student-link">
                <span id="student-link-text">{{ student_access_url }}</span>
                <button type="button" class="copy-btn" onclick="copyStudentLink()" data-i18n="copy_link">
                    üìã Copy Link
                </button>
            </div>
            <p style="margin: 10px 0 0 0; color: #666; font-size: 12px;" data-i18n="share_link_instruction">
                Share this link with your students. Each student will access it with their own session.
            </p>
        </div>
    </div>
    
    <!-- Statistics -->
    <div class="stats-grid">
        <div class="stat-box active">
            <div class="stat-number" id="stat-active">0</div>
            <div class="stat-label" data-i18n="in_progress">In Progress</div>
        </div>
        <div class="stat-box completed">
            <div class="stat-number" id="stat-completed">0</div>
            <div class="stat-label" data-i18n="completed">Completed</div>
        </div>
        <div class="stat-box suspicious">
            <div class="stat-number" id="stat-suspicious">0</div>
            <div class="stat-label" data-i18n="suspicious_activity">Suspicious Activity</div>
        </div>
        <div class="stat-box">
            <div class="stat-number" id="stat-total">0</div>
            <div class="stat-label" data-i18n="total_students">Total Students</div>
        </div>
    </div>
    
    <!-- Controls -->
    <div class="controls">
        <button type="button" class="btn btn-primary" onclick="refreshData()" data-i18n="refresh_now">
            üîÑ Refresh Now
        </button>
        <button type="button" class="btn btn-secondary" onclick="toggleAutoRefresh()" data-i18n="stop_auto_refresh">
            ‚è∏ Stop Auto-Refresh
        </button>
        <a href="{{ url_for('teacher_exams') }}" class="btn btn-secondary" data-i18n="back_to_exams">
            ‚Üê Back to Exams
        </a>
    </div>
    
    <!-- Students Table -->
    <div class="card">
        <div class="card-header">
            <h3 style="margin: 0;" data-i18n="student_activity">üë• Student Activity</h3>
        </div>
        <div class="card-body">
            <table class="students-table">
                <thead>
                    <tr>
                        <th data-i18n="student_name">Student Name</th>
                        <th data-i18n="status">Status</th>
                        <th data-i18n="time_spent">Time Spent</th>
                        <th data-i18n="score">Score</th>
                        <th data-i18n="suspicious_activity">Suspicious Activity</th>
                    </tr>
                </thead>
                <tbody id="students-tbody">
                    <tr>
                        <td colspan="5" class="no-students" data-i18n="loading">
                            Loading student data...
                        </td>
                    </tr>
                </tbody>
            </table>
            <div class="refresh-info" id="refresh-info" data-i18n="auto_refreshing">
                Auto-refreshing every 2 seconds...
            </div>
        </div>
    </div>
</div>

<script>
const EXAM_ID = {{ exam_id }};
let autoRefreshEnabled = true;
let refreshInterval = null;

// ========================================================================
// INITIALIZATION
// ========================================================================

document.addEventListener('DOMContentLoaded', () => {
    refreshData();
    startAutoRefresh();
});

// ========================================================================
// AUTO-REFRESH
// ========================================================================

function startAutoRefresh() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
    
    refreshInterval = setInterval(() => {
        if (autoRefreshEnabled) {
            refreshData();
        }
    }, 2000);  // Refresh every 2 seconds
}

function toggleAutoRefresh() {
    autoRefreshEnabled = !autoRefreshEnabled;
    
    const btn = event.target;
    if (autoRefreshEnabled) {
        btn.textContent = '‚è∏ Stop Auto-Refresh';
        btn.style.background = '#6c757d';
        document.getElementById('refresh-info').textContent = 'Auto-refreshing every 2 seconds...';
        startAutoRefresh();
    } else {
        btn.textContent = '‚ñ∂ Resume Auto-Refresh';
        btn.style.background = '#28a745';
        document.getElementById('refresh-info').textContent = 'Auto-refresh paused. Click "Refresh Now" to update.';
    }
}

// ========================================================================
// DATA REFRESH
// ========================================================================

async function refreshData() {
    try {
        const response = await fetch(`/api/exam/${EXAM_ID}/students`);
        const data = await response.json();
        
        if (data.success) {
            updateStudentsTable(data.students);
            updateStatistics(data.students);
        }
    } catch (error) {
        console.error('Error refreshing data:', error);
    }
}

// ========================================================================
// UPDATE TABLE
// ========================================================================

function updateStudentsTable(students) {
    const tbody = document.getElementById('students-tbody');
    
    if (students.length === 0) {
        const noStudentsText = window.i18n?.t('no_students_yet') || 'No students yet. Share the link above.';
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="no-students">
                    ${noStudentsText}
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = students.map(student => {
        const statusBadge = getStatusBadge(student.status);
        const timeSpent = formatTimeSpent(student.time_spent);
        const score = formatScore(student.score);
        const suspiciousIcon = getSuspiciousIcon(student);
        
        return `
            <tr>
                <td>${escapeHtml(student.name)}</td>
                <td>${statusBadge}</td>
                <td><span class="time-display">${timeSpent}</span></td>
                <td>${score}</td>
                <td>${suspiciousIcon}</td>
            </tr>
        `;
    }).join('');
}

// ========================================================================
// UPDATE STATISTICS
// ========================================================================

function updateStatistics(students) {
    let active = 0;
    let completed = 0;
    let suspicious = 0;
    
    students.forEach(student => {
        if (student.status === 'in_progress') {
            active++;
        } else if (student.status === 'completed') {
            completed++;
        }
        
        if (student.cheating_attempts > 0) {
            suspicious++;
        }
    });
    
    document.getElementById('stat-active').textContent = active;
    document.getElementById('stat-completed').textContent = completed;
    document.getElementById('stat-suspicious').textContent = suspicious;
    document.getElementById('stat-total').textContent = students.length;
}

// ========================================================================
// UI HELPERS
// ========================================================================

function getStatusBadge(status) {
    const statusMap = {
        'in_progress': { label: 'üîµ In Progress', class: 'status-in-progress' },
        'completed': { label: '‚úÖ Completed', class: 'status-completed' },
        'abandoned': { label: '‚ö†Ô∏è Abandoned', class: 'status-abandoned' }
    };
    
    const info = statusMap[status] || { label: '‚ùì Unknown', class: '' };
    return `<span class="status-badge ${info.class}">${info.label}</span>`;
}

function formatTimeSpent(seconds) {
    if (!seconds) return '‚Äî';
    
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    
    return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
}

function formatScore(score) {
    if (score === null || score === undefined) return '‚Äî';
    
    let scoreClass = 'low';
    if (score >= 80) scoreClass = 'high';
    else if (score >= 60) scoreClass = 'medium';
    
    return `<span class="score-display ${scoreClass}">${score}%</span>`;
}

function getSuspiciousIcon(student) {
    if (student.cheating_attempts > 0) {
        return `<span class="cheating-warning">
            ‚ö†Ô∏è ${student.cheating_attempts} attempt(s)
        </span>`;
    }
    return '‚Äî';
}

function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}

// ========================================================================
// COPY LINK
// ========================================================================

function copyStudentLink() {
    const link = document.getElementById('student-link-text').textContent;
    navigator.clipboard.writeText(link).then(() => {
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = '‚úì Copied!';
        
        setTimeout(() => {
            btn.textContent = originalText;
        }, 2000);
    });
}

// ========================================================================
// CLEANUP
// ========================================================================

window.addEventListener('beforeunload', () => {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
});
</script>

{% endblock %}
