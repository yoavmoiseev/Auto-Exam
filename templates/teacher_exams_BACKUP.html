{% extends "base.html" %}

{% block title %}My Exams - Exam System{% endblock %}

{% block content %}
<div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
    <h1 data-i18n="my_exams" style="margin: 0;">My Exams</h1>
    <a href="{{ url_for('teacher_dashboard') }}" class="btn btn-secondary" data-i18n="back_to_dashboard">Back to Dashboard</a>
</div>

<div style="clear: both;"></div>

<div class="card">
    <div class="card-header">
        <h3 data-i18n="uploaded_exams">Uploaded Exams</h3>
    </div>
    <div class="card-body">
        <div id="loading" style="display: none; text-align: center;">
            <p data-i18n="loading">Loading...</p>
        </div>
        
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="border-bottom: 2px solid #ddd;">
                    <th style="padding: 10px; text-align: left;" data-i18n="exam_name">Exam Name</th>
                    <th style="padding: 10px; text-align: center;" data-i18n="actions">Actions</th>
                </tr>
            </thead>
            <tbody id="exams-list">
                <tr>
                    <td colspan="2" style="padding: 20px; text-align: center;" data-i18n="no_exams">No exams available</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Include Exam Settings Modal -->
{% include 'exam_settings_modal.html' %}

<script>
// Load exams list on page load
document.addEventListener('DOMContentLoaded', loadExams);

// Reload exams when language changes
window.addEventListener('languageChanged', loadExams);

function loadExams() {
    document.getElementById('loading').style.display = 'block';
    
    fetch('/api/exams-list')
        .then(response => response.json())
        .then(data => {
            document.getElementById('loading').style.display = 'none';
            
            if (data.success && data.exams.length > 0) {
                const tbody = document.getElementById('exams-list');
                tbody.innerHTML = '';
                
                // Get translated button labels
                const startLabel = typeof i18n !== 'undefined' ? i18n.t('start') : 'Start';
                const deleteLabel = typeof i18n !== 'undefined' ? i18n.t('delete') : 'Delete';
                
                data.exams.forEach(exam => {
                    const row = document.createElement('tr');
                    row.style.borderBottom = '1px solid #ddd';
                    
                    row.innerHTML = `
                        <td style="padding: 10px;">${escapeHtml(exam)}</td>
                        <td style="padding: 10px; text-align: center;">
                            <button class="btn btn-primary btn-sm" onclick="startExam('${escapeHtml(exam)}')" style="margin-right: 5px;">
                                ${startLabel}
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteExam('${escapeHtml(exam)}')">
                                ${deleteLabel}
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('loading').style.display = 'none';
        });
}

function startExam(examName) {
    // Open settings modal instead of directly starting
    openExamSettingsModal(examName);
}

function deleteExam(examName) {
    if (confirm(window.i18n?.t('confirm_delete_exam', {exam_name: examName}) || 'Are you sure you want to delete: ' + examName + '?')) {
        fetch('/api/delete-exam/' + encodeURIComponent(examName), {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(window.i18n?.t('exam_deleted_successfully') || 'Exam deleted successfully');
                loadExams();
            } else {
                alert((window.i18n?.t('error_generic') || 'Error') + ': ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert(window.i18n?.t('error_deleting_exam') || 'Error deleting exam');
        });
    }
}

function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    if (typeof text !== 'string') return text;
    text = text.replace(/\${/g, '&#36;{');
    text = text.replace(/`/g, '&#96;');
    text = text.replace(/\\/g, '\\');
    return text.replace(/[&<>"'`]/g, m => map[m] || m);
}
</script>

<style>
.btn-sm {
    padding: 5px 10px;
    font-size: 13px;
}

.btn-danger {
    background-color: #dc3545;
    color: white;
}

.btn-danger:hover {
    background-color: #c82333;
}
</style>

{% endblock %}
