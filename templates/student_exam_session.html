{% extends "base_student.html" %}

{% block title %}{{ exam_title }}{% endblock %}

{% block content %}
<!-- NEW v4: Apply translation blocking if enabled -->
<!-- REMARK: Previously no translate attribute -->
<div class="exam-container{% if block_translation %} notranslate{% endif %}"{% if block_translation %} translate="no"{% endif %}>
<style>
    .exam-container {
        max-width: 900px;
        margin: 0 auto;
    }
    
    /* RTL support */
    .exam-container.rtl,
    .rtl .question-block,
    .rtl .pre-exam-form,
    .rtl .card,
    .rtl .alert-warning,
    .rtl .alert-danger {
        direction: rtl;
        text-align: right;
    }
    
    .rtl .form-group label {
        text-align: right;
    }
    
    .rtl .timer {
        left: 20px;
        right: auto;
    }
    
    .pre-exam-screen {
        display: block;
    }
    
    .exam-screen {
        display: none;
    }
    
    .alert-warning {
        background: #fff3cd;
        border: 2px solid #ffc107;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
        color: #856404;
    }
    
    .alert-danger {
        background: #f8d7da;
        border: 2px solid #f5c6cb;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
        color: #721c24;
    }
    
    .warning-text {
        font-weight: bold;
        font-size: 16px;
        margin: 10px 0;
    }
    
    .pre-exam-form {
        background: #f9f9f9;
        padding: 20px;
        border-radius: 5px;
        border: 1px solid #ddd;
    }
    
    .form-group {
        margin-bottom: 15px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #333;
    }
    
    .form-group input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
        box-sizing: border-box;
    }
    
    .btn-start-exam {
        width: 100%;
        padding: 15px;
        background-color: #dc3545;
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        margin-top: 10px;
    }
    
    .btn-start-exam:hover {
        background-color: #c82333;
    }
    
    .timer {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        padding: 15px 25px;
        border: 3px solid #007bff;
        border-radius: 8px;
        font-size: 24px;
        font-weight: bold;
        z-index: 100;
        min-width: 120px;
        text-align: center;
    }
    
    .timer.warning {
        border-color: #ffc107;
        color: #ffc107;
    }
    
    .timer.critical {
        border-color: #dc3545;
        color: #dc3545;
        animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    .question-block {
        margin-bottom: 30px;
        padding: 20px;
        background: #f9f9f9;
        border-radius: 8px;
        border-left: 4px solid #007bff;
    }
    
    .question-text {
        font-weight: bold;
        font-size: 16px;
        margin-bottom: 15px;
        color: #333;
    }
    
    .answer-option {
        margin-bottom: 10px;
    }
    
    .answer-option input {
        margin-right: 10px;
    }
    
    .answer-option label {
        cursor: pointer;
    }
    
    .buttons-container {
        display: flex;
        gap: 10px;
        margin-top: 30px;
        justify-content: space-between;
    }
    
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
    }
    
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
    
    .btn-primary {
        background: #007bff;
        color: white;
    }
    
    .btn-success {
        background: #28a745;
        color: white;
    }
    
    .btn:hover {
        opacity: 0.8;
    }
    
    .results-display {
        display: none;
        text-align: center;
        padding: 40px;
    }
    
    .results-display h2 {
        font-size: 36px;
        color: #28a745;
        margin-bottom: 20px;
    }
    
    .results-display p {
        font-size: 18px;
        margin-bottom: 20px;
    }
</style>

<div class="exam-container">
    <!-- ============================================================ -->
    <!-- STAGE 1: PRE-EXAM SCREEN -->
    <!-- ============================================================ -->
    <div id="pre-exam-screen" class="pre-exam-screen">
        <div class="card">
            <div class="card-header">
                <h1 style="margin: 0;">{{ exam_title }}</h1>
            </div>
            <div class="card-body">
                <!-- WARNINGS -->
                <div class="alert-danger">
                    <h3 style="margin-top: 0;">‚ö†Ô∏è IMPORTANT WARNINGS</h3>
                    
                    <div class="warning-text">üö´ DO NOT leave this page during the exam</div>
                    <p>If you switch tabs, minimize window, or refresh the page, it will be recorded as a cheating attempt.</p>
                    
                    <div class="warning-text">üö´ DO NOT copy or paste answers</div>
                    <p>Any attempt to copy text will be logged and reported.</p>
                    
                    <div class="warning-text">üö´ Developer Tools are disabled</div>
                    <p>Attempting to open DevTools (F12, Ctrl+Shift+I) will be recorded.</p>
                    
                    <div class="warning-text">üì± Use a single device only</div>
                    <p>This exam must be completed on one device.</p>
                    
                    <hr style="margin: 15px 0;">
                    
                    <!-- Russian warnings -->
                    <div class="warning-text">üö´ –ù–ï –ü–û–ö–ò–î–ê–ô–¢–ï —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤–æ –≤—Ä–µ–º—è —ç–∫–∑–∞–º–µ–Ω–∞</div>
                    <p>–ï—Å–ª–∏ –≤—ã –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ—Å—å –Ω–∞ –¥—Ä—É–≥—É—é –≤–∫–ª–∞–¥–∫—É –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É, —ç—Ç–æ –±—É–¥–µ—Ç –∑–∞–ø–∏—Å–∞–Ω–æ.</p>
                    
                    <!-- Hebrew warnings -->
                    <div class="warning-text" style="direction: rtl;">üö´ ◊ê◊ú ◊™◊¢◊ñ◊ï◊ë ◊ê◊™ ◊ì◊£ ◊ñ◊î ◊ë◊û◊î◊ú◊ö ◊î◊ë◊ó◊ô◊†◊î</div>
                    <p style="direction: rtl;">◊ê◊ù ◊™◊¢◊ë◊ï◊® ◊ú◊õ◊®◊ò◊ô◊°◊ô◊ô◊î ◊ê◊ó◊®◊™ ◊ê◊ï ◊™◊®◊¢◊†◊ü ◊ê◊™ ◊î◊ì◊£, ◊ñ◊î ◊ô◊ô◊®◊©◊ù ◊õ◊†◊ô◊°◊ô◊ï◊ü ◊î◊¢◊®◊û◊î.</p>
                </div>
                
                <!-- STUDENT NAME INPUT -->
                <form id="pre-exam-form" class="pre-exam-form">
                    <div class="form-group">
                        <label for="first-name" data-i18n="first_name">First Name *</label>
                        <input type="text" id="first-name" name="first_name" required autofocus>
                    </div>
                    
                    <div class="form-group">
                        <label for="last-name" data-i18n="last_name">Last Name *</label>
                        <input type="text" id="last-name" name="last_name" required>
                    </div>
                    
                    <button type="submit" class="btn-start-exam" data-i18n="start_exam">
                        üöÄ START EXAM
                    </button>
                </form>
                
                <!-- TRANSLATION TRACKING: exam_instructions (ID 101.1) + instruction lines (IDs 101.2-101.5) -->
                <div class="alert-warning" style="margin-top: 20px;">
                    <strong data-i18n="exam_instructions">‚ÑπÔ∏è Instructions:</strong>
                    <ol style="margin: 10px 0; padding-left: 20px;">
                        <li data-i18n="enter_name_above">Enter your name above</li>
                        <li data-i18n="click_start_exam_instruction">Click START EXAM - exam will load immediately</li>
                        <li data-i18n="answer_all_questions_instruction">Answer all questions</li>
                        <li data-i18n="click_submit_instruction">Click SUBMIT when finished</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ============================================================ -->
    <!-- STAGE 2: ACTIVE EXAM SCREEN -->
    <!-- ============================================================ -->
    <div id="exam-screen" class="exam-screen">
        <!-- Timer -->
        <div id="timer" class="timer">00:00</div>
        
        <!-- Exam Card -->
        <div class="card">
            <div class="card-header">
                <h2 style="margin: 0;">{{ exam_title }}</h2>
                <small style="color: #666;" data-i18n="answer_all_questions">Answer all questions below</small>
            </div>
            
            <div class="card-body">
                <!-- Questions Container -->
                <form id="exam-form">
                    <div id="questions-container">
                        <!-- Questions will be loaded here by JavaScript -->
                    </div>
                    
                    <!-- Navigation Buttons -->
                    <div class="buttons-container">
                        <button type="button" class="btn btn-secondary" style="visibility: hidden;">
                            ‚Üê Previous
                        </button>
                        <button type="submit" class="btn btn-success" style="width: auto;" data-i18n="submit_exam_button">
                            ‚úì SUBMIT EXAM
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- ============================================================ -->
    <!-- EXAM RESULTS -->
    <!-- ============================================================ -->
    <div id="exam-results" class="results-display">
        <div class="card">
            <div class="card-header">
                <h3 data-i18n="exam_completed">Exam Completed</h3>
            </div>
            <div class="card-body">
                <div id="results-content">
                    <!-- Results will be inserted here -->
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- Load the proctoring system -->
<script src="{{ url_for('static', filename='proctoring.js') }}"></script>

<script>
// TRANSLATION FIX v1: Initialize i18n with exam language from server
// REMARK: Previously i18n initialized with localStorage language (dashboard language)
// NOW: Force exam language to match exam content language
const EXAM_LANGUAGE = '{{ exam_language }}';  // Passed from Flask route

// Helper function to get translation based on EXAM language (not system language)
// CRITICAL: This ensures placeholders and exam UI use the exam's language
function getExamTranslation(key) {
    const examTranslations = {
        'type_answer_placeholder': {
            'en': 'Type your answer here',
            'he': '◊î◊ß◊ú◊ì ◊ê◊™ ◊î◊™◊©◊ï◊ë◊î ◊©◊ú◊ö ◊õ◊ê◊ü',
            'ru': '–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç –∑–¥–µ—Å—å'
        }
    };
    return examTranslations[key]?.[EXAM_LANGUAGE] || examTranslations[key]?.['en'] || '';
}

// NEW v4: Exam protection settings
const BLOCK_TRANSLATION = {{ 'true' if block_translation else 'false' }};
const FULLSCREEN_MODE = {{ 'true' if fullscreen_mode else 'false' }};

// Initialize i18n manager
window.i18n = new I18nManager();

// Wait for i18n to be ready, then set exam language
window.i18n.readyPromise.then(() => {
    // Force exam language (override localStorage)
    if (EXAM_LANGUAGE && EXAM_LANGUAGE !== window.i18n.currentLanguage) {
        window.i18n.switchLanguage(EXAM_LANGUAGE);
    }
});

// NEW v4: Fullscreen enforcement
if (FULLSCREEN_MODE) {
    function enterFullscreen() {
        const elem = document.documentElement;
        if (elem.requestFullscreen) {
            elem.requestFullscreen();
        } else if (elem.webkitRequestFullscreen) {
            elem.webkitRequestFullscreen();
        } else if (elem.msRequestFullscreen) {
            elem.msRequestFullscreen();
        }
    }
    
    // Monitor fullscreen exit
    document.addEventListener('fullscreenchange', () => {
        if (!document.fullscreenElement && examStarted) {
            logCheatingAttempt('fullscreen_exit');
        }
    });
    
    // Enter fullscreen when exam starts
    window.addEventListener('examStarted', enterFullscreen);
}
</script>

<script>
/**
 * Exam-specific initialization
 * Loads questions and handles exam submission
 */

let examQuestions = [];
let currentQuestionIndex = 0;
let textDirection = 'ltr';  // Store text direction from server

// Load exam data after student clicks START
async function loadExamData() {
    const examId = getExamIdFromURL();
    
    try {
        const response = await fetch(`/api/exam/${examId}/questions`);
        const data = await response.json();
        
        if (data.success) {
            examQuestions = data.questions;
            // TRANSLATION FIX v1: Store text_direction from server
            // REMARK: Previously text_direction not extracted from API response
            textDirection = data.text_direction || 'ltr';
            // NOTE: Language already set during page load (see EXAM_LANGUAGE above)
            displayAllQuestions();
        } else {
            alert(window.i18n?.t('error_loading_questions') || 'Error loading exam questions');
        }
    } catch (error) {
        console.error('Error:', error);
        alert(window.i18n?.t('error_occurred') || 'An error occurred');
    }
}

function displayAllQuestions() {
    const container = document.getElementById('questions-container');
    container.innerHTML = '';
    
    // Apply RTL to container if needed
    if (textDirection === 'rtl') {
        container.style.direction = 'rtl';
    }
    
    examQuestions.forEach((question, index) => {
        const questionDiv = document.createElement('div');
        questionDiv.className = 'question-block';
        questionDiv.id = `question-${index}`;
        
        // NEW v4: Apply translation blocking if enabled
        // REMARK: Previously no translate attribute on questions
        if (BLOCK_TRANSLATION) {
            questionDiv.classList.add('notranslate');
            questionDiv.setAttribute('translate', 'no');
        }
        
        // Apply RTL to question div if needed
        if (textDirection === 'rtl') {
            questionDiv.style.direction = 'rtl';
            questionDiv.style.textAlign = 'right';
        }
        
        let html = `
            <div class="question-text">
                ${question.number}. ${escapeHtml(question.text)}
            </div>
        `;
        
        // Check if it's an open-ended question
        if (question.type === 'open') {
            // Display instructions if any (skip marker text)
            if (question.answers && question.answers.length > 0) {
                const instructions = question.answers.filter(ans => 
                    !ans.includes('Programming task:') && 
                    !ans.includes('Open Question') &&
                    !ans.includes('Type your answer here')
                );
                
                if (instructions.length > 0) {
                    // FIXED: Preserve multi-line formatting using <br> instead of joining with space
                    const instructionsHtml = instructions.map(line => escapeHtml(line)).join('<br>');
                    html += `<div style="color: #666; font-style: italic; margin-bottom: 10px; white-space: pre-wrap;">${instructionsHtml}</div>`;
                }
            }
            
            html += `
                <textarea 
                    name="question-${index}" 
                    id="answer-${index}"
                    placeholder="${getExamTranslation('type_answer_placeholder')}..."
                    style="width: 100%; min-height: 120px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace;"
                    required></textarea>
            `;
        } else {
            // Multiple choice question - display all answers as radio buttons
            if (question.answers && question.answers.length > 0) {
                question.answers.forEach((answer, answerIndex) => {
                    html += `
                        <div class="answer-option">
                            <label style="display: flex; align-items: flex-start; padding: 8px;">
                                <input 
                                    type="radio" 
                                    name="question-${index}" 
                                    value="${escapeHtml(answer)}"
                                    id="option-${index}-${answerIndex}"
                                    style="margin-right: 10px; margin-top: 3px;"
                                    required>
                                <span>${escapeHtml(answer)}</span>
                            </label>
                        </div>
                    `;
                });
            }
        }
        
        questionDiv.innerHTML = html;
        container.appendChild(questionDiv);
    });
}

// Handle exam submission
document.addEventListener('DOMContentLoaded', () => {
    const examForm = document.getElementById('exam-form');
    if (examForm) {
        examForm.addEventListener('submit', handleExamSubmit);
    }
});

async function handleExamSubmit(e) {
    e.preventDefault();
    
    // Collect all answers using question text as key
    const answers = {};
    examQuestions.forEach((question, index) => {
        const answer = document.querySelector(`input[name="question-${index}"]:checked`) || 
                      document.querySelector(`textarea[name="question-${index}"]`);
        
        if (answer) {
            // Use question text as key for matching on server
            answers[question.text] = answer.value;
        }
    });
    
    // Check if all questions are answered
    if (Object.keys(answers).length !== examQuestions.length) {
        alert(window.i18n?.t('answer_all_questions') || 'Please answer all questions before submitting');
        return;
    }
    
    // Submit exam
    await submitExam(answers);
}

// Variables declared in proctoring.js:
// - studentSessionId
// - examQuestions
// Student names are set in proctoring.js as window.studentFirstName and window.studentLastName

// Get exam ID from URL
function getExamIdFromURL() {
    const path = window.location.pathname;
    const match = path.match(/\/exam\/(\d+)/);
    return match ? parseInt(match[1]) : null;
}

// Collect device fingerprint for fraud detection
async function collectDeviceInfo() {
    try {
        // Generate canvas fingerprint
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        ctx.textBaseline = 'top';
        ctx.font = '14px Arial';
        ctx.textBaseline = 'alphabetic';
        ctx.fillStyle = '#f60';
        ctx.fillRect(125, 1, 62, 20);
        ctx.fillStyle = '#069';
        ctx.fillText('ExamSystem', 2, 15);
        ctx.fillStyle = 'rgba(102, 204, 0, 0.7)';
        ctx.fillText('fpjs.io', 4, 17);
        const canvasData = canvas.toDataURL();
        
        // Create simple hash from canvas
        let hash = 0;
        for (let i = 0; i < canvasData.length; i++) {
            const char = canvasData.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash;
        }
        const canvasHash = Math.abs(hash).toString(36).substring(0, 8);
        
        // Collect other identifiers
        const screenInfo = `${screen.width}x${screen.height}x${screen.colorDepth}`;
        const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
        const language = navigator.language || navigator.userLanguage;
        const platform = navigator.platform;
        const userAgent = navigator.userAgent;
        
        // Generate device ID from multiple sources
        const deviceString = `${canvasHash}|${screenInfo}|${timezone}|${platform}`;
        let deviceHash = 0;
        for (let i = 0; i < deviceString.length; i++) {
            deviceHash = ((deviceHash << 5) - deviceHash) + deviceString.charCodeAt(i);
            deviceHash = deviceHash & deviceHash;
        }
        const deviceId = Math.abs(deviceHash).toString(36).substring(0, 12);
        
        return {
            device_id: deviceId,
            screen_resolution: screenInfo,
            timezone: timezone,
            language: language,
            platform: platform,
            user_agent: userAgent
        };
    } catch (e) {
        console.error('Error collecting device info:', e);
        return {
            device_id: 'unknown',
            screen_resolution: 'unknown',
            timezone: 'unknown',
            language: navigator.language || 'unknown',
            platform: navigator.platform || 'unknown',
            user_agent: navigator.userAgent || 'unknown'
        };
    }
}

// Handle pre-exam form submission (name entry)
// Note: Form handling is done in proctoring.js to avoid duplicate student registration
document.addEventListener('DOMContentLoaded', () => {
    // Form is handled by proctoring.js handlePreExamSubmit()
});

// Submit exam
async function submitExam(answers) {
    const examId = getExamIdFromURL();
    
    if (!confirm(window.i18n?.t('confirm_submit_exam') || 'Are you sure you want to submit your exam?\n\nYou cannot change your answers after submission.')) {
        return;
    }
    
    try {
        // Collect device information for fraud detection
        const deviceInfo = await collectDeviceInfo();
        
        const response = await fetch(`/api/exam/${examId}/submit`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                student_session_id: studentSessionId,
                first_name: window.studentFirstName,
                last_name: window.studentLastName,
                answers: answers,
                questions: examQuestions,  // Send questions list to preserve order
                device_info: deviceInfo  // Add device fingerprint for tracking
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Stop proctoring to prevent counting suspicious activity on results page
            if (typeof stopProctoring === 'function') {
                stopProctoring();
            }
            
            // Hide exam screen
            document.getElementById('exam-screen').style.display = 'none';
            
            // Show results
            const resultsDiv = document.getElementById('exam-results');
            const resultsContent = document.getElementById('results-content');
            
            // Insert the response HTML from server
            if (data.response_html) {
                resultsContent.innerHTML = data.response_html;
            } else {
                // Fallback
                const scoreText = data.score < 0 ? 'Will be evaluated later' : `${data.score}%`;
                resultsContent.innerHTML = `
                    <h2>Exam Submitted Successfully!</h2>
                    <h3>Your Score: ${scoreText}</h3>
                    <p>Thank you, ${window.studentFirstName} ${window.studentLastName}</p>
                `;
            }
            
            resultsDiv.style.display = 'block';
        } else {
            alert((window.i18n?.t('error_submitting_exam') || 'Error submitting exam') + ': ' + data.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert(window.i18n?.t('failed_submit_exam') || 'Failed to submit exam');
    }
}

// Simple timer (timerInterval declared in proctoring.js)
let timerSeconds = 0;

function startTimer() {
    timerInterval = setInterval(() => {
        timerSeconds++;
        const minutes = Math.floor(timerSeconds / 60);
        const seconds = timerSeconds % 60;
        document.getElementById('timer').textContent = 
            `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }, 1000);
}

function stopTimer() {
    if (timerInterval) {
        clearInterval(timerInterval);
    }
}

function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    if (typeof text !== 'string') return text;
    text = text.replace(/\${/g, '&#36;{');
    text = text.replace(/`/g, '&#96;');
    text = text.replace(/\\/g, '\\');
    return text.replace(/[&<>"'`]/g, m => map[m] || m);
}
</script>
{% endblock %}
